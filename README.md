# Базовая настройка

## Запуск minikube

[Инструкция по установке](https://minikube.sigs.k8s.io/docs/start/)

```bash
minikube start
```

## Добавление токена авторизации GitHub

[Получение токена](https://github.com/settings/tokens/new)

```bash
kubectl create secret docker-registry ghcr --docker-server=https://ghcr.io --docker-username=<github_username> --docker-password=<github_token> -n default
```

## Установка API GW kusk

[Install Kusk CLI](https://docs.kusk.io/getting-started/install-kusk-cli)

```bash
kusk cluster install
```

## Смена адреса образа в helm chart

После того как вы сделали форк репозитория и у вас в репозитории отработал GitHub Action. Вам нужно получить адрес образа <https://github.com/><github_username>/architecture-sprint-3/pkgs/container/architecture-sprint-3

Он выглядит таким образом
```ghcr.io/<github_username>/architecture-sprint-3:latest```

Замените адрес образа в файле `helm/smart-home-monolith/values.yaml` на полученный файл:

```yaml
image:
  repository: ghcr.io/<github_username>/architecture-sprint-3
  tag: latest
```

## Настройка terraform

[Установите Terraform](https://yandex.cloud/ru/docs/tutorials/infrastructure-management/terraform-quickstart#install-terraform)

Создайте файл ~/.terraformrc

```hcl
provider_installation {
  network_mirror {
    url = "https://terraform-mirror.yandexcloud.net/"
    include = ["registry.terraform.io/*/*"]
  }
  direct {
    exclude = ["registry.terraform.io/*/*"]
  }
}
```

## Применяем terraform конфигурацию

```bash
cd terraform
terraform init
terraform apply
```

## Настройка API GW

```bash
kusk deploy -i api.yaml
```

## Проверяем работоспособность

```bash
kubectl port-forward svc/kusk-gateway-envoy-fleet -n kusk-system 8080:80
curl localhost:8080/hello
```

## Delete minikube

```bash
minikube delete
```

## Задание N1 Анализ и планирование

### Домены и границы контекстов

Домен: Управление температурой дома. 
* Поддомен: управление отоплением
  * контекст: управление устройствами отопления пользователем
* Мониторинг
  * контекст: получение данных с устройств отопления 

Основных поддоменов можно выделить два, управление устройствами отопления в доме и мониторинг устройств.  Управление включает в себя включение/выключения устройств, и изменения температуры. Мониторинг включает  себя получение информации с устройств.

### Проблемы текущей архитектуры монолитного приложения
Что ожидается в новом приложении:
* Четко определенная новая функиональность
* Много новых клиентов
* В будущем добавление нового функционала

Ниже определены недостатки нового приложения исходя из определенных требований
* Взаимодействие только синхронное. После выделения микросервисов скорее всего для взаимодействия между ними нужен будет брокер сообщений. Также некторая часть взаимодействия с системой целесобразнее будет выделить в асинхронный варинат. Например если операция подключения устройств долгий процесс, то лучше будет сделать оерацию асинхронной.
* Приложение ограничено с плане масштабируемости, так как отдельные части не масштабируются
* Тестируемость. При внесении изменений нужно тестировать всю приложение.
* Приложение разворачивается полностью
* В текущем варианте приложения работа осуществляется только с устройствами. Нет сущности дом. Данная сущность будет необходима так как позволит лучше группировать устройства и позволит пользователям более удобно управлять своими устройствами и мониторить.
* Взаимодействие с устройствами идет только от сервера к устройсту. В новой сиситеме устройства должны сами подключаться к системе. Имеет смысл добавить возможность взаимодействия от устройств в серверу. Так как есть требование наблюдать за домом, изменения состояний(например выключили свет руками в доме) систем дома должны отправляться на сервер. Также это имеет смысл для контроля живо устройство или нет.

### Диаграмма контекста C4
![SVG Image](/diagrams/old/context/С4_context.svg)

## Задание 2. Проектирование микросервисной архитектуры

Выделенные микросервисы:
* Сервис управления устройствами
* Сервис телеметрии
* Сервис нотификации
* Сервис пользователей

### Общие моменты

Добавленн api_gateway для балансировки, прокси, авторизации, может быть кэширования. Добавлен брокер сообщений kafka для асинхронного взаимодйствия миккросервисов. Добавлен service_discovery: сервисы регистрируются при старте.

### Сервис пользователей

Данный сервис предназначен для работы с пользовательскими данными: профиль, хэши паролей, регистарция, аутентификация и т.д. 

### Сервис нотификации

Данный сервси предназначен для отправки сообщений пользователям. Сообщениямогут отправляться различными способами: по почте, на моблильные устройства пуш сообщениями. На будущее можно добавить еще вариант смс. Команды на отправку сообщений сервис получает из брокера сообщений.

### Сервис управления устройствами

Данный сервис предназначен для подключения устройств, получения данных с устройств и управления устройствами. Устройства подключаются к сервису по протоколу websocket и в рамках этого соединения отправляют данные телеметрии и опционально health чеки и получают команды от сервиса. Получаемые данные телеметрии отправляются в сервис телеметрии через брокер сообщений. Выбран протокол websocket так: 
  * Стандартный 
  * Двунаправленный. Установив соединение можно отправлять данные в обе стороны
  * Для соединения используются стандартные HTTP порты, что важно когда приборы находятся иззвне. 

### Сервис телеметрии

Данный сервис предназначен для сохранения данных телеметрии и выдачу этих данных по запросу. Так оперций на запись предпалагается много то целесообразно на запись и чтение выделить разные базы. Например настроить реплику только на чтение а мастер на запись. В будущем можно разные базы использовать.

### Диаграмма контекста C4

![SVG Image](/diagrams/new/context/C4_context.svg)

### Диаграмма контейнеров C4

![SVG Image](/diagrams/new/containers/C4_containers.svg)

### Диаграмма компонентов C4

![SVG Image](/diagrams/new/components/C4_components.svg)

## Задание 3. Разработка ER-диаграммы

Диаграмма

![SVG Image](/diagrams/new/erd/ERD.svg)